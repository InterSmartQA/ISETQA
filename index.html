<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ISET QA Handbook and Attendance Tracker</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Roboto', sans-serif;
    }

    body {
      background-color: #f1f3f4;
      color: #202124;
      line-height: 1.5;
    }

    #pageLoader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #ffffff;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.3s ease;
    }

    #pageLoader.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loader-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #5f6368;
      border-top: 4px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    header {
      background-color: #fff;
      border-bottom: 1px solid #dadce0;
      padding: 1rem;
      text-align: center;
      position: relative;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    header img {
      max-width: 150px;
      margin-bottom: 0.5rem;
    }

    header h1 {
      font-size: 1.25rem;
      font-weight: 400;
      color: #202124;
    }

    #logoutButton {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background-color: #1a73e8;
      color: #ffffff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s;
      display: none;
    }

    #logoutButton:hover {
      background-color: #1557b0;
    }

    #logoutButton.loading {
      opacity: 0.7;
      cursor: not-allowed;
    }

    nav {
      background-color: #f1f3f4;
      padding: 0.5rem;
      border-bottom: 1px solid #dadce0;
    }

    .tabs {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
    }

    .tab {
      padding: 0.5rem 1rem;
      color: #202124;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.2s;
      font-weight: 500;
      background-color: #e8eaed;
    }

    .tab.active, .tab:hover {
      background-color: #d2e3fc;
      color: #1a73e8;
    }

    .tab-content {
      display: none;
      padding: 1rem;
      background-color: #ffffff;
      border: 1px solid #dadce0;
      margin: 1rem;
      border-radius: 4px;
    }

    .tab-content.active {
      display: block;
    }

    .table-container {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-top: 1rem;
      position: relative;
      background-color: #ffffff;
      border: 1px solid #dadce0;
      border-radius: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #ffffff;
      table-layout: auto;
    }

    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #dadce0;
      border-right: 1px solid #dadce0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 100px;
      font-size: 0.875rem;
    }

    th {
      background-color: #f1f3f4;
      color: #202124;
      font-weight: 500;
      position: sticky;
      top: 0;
      z-index: 10;
      user-select: none;
      border-top: 1px solid #dadce0;
    }

    th:last-child, td:last-child {
      border-right: none;
    }

    th:hover {
      background-color: #e8eaed;
    }

    .resize-handle {
      position: absolute;
      top: 0;
      right: 0;
      width: 5px;
      height: 100%;
      cursor: col-resize;
      background-color: transparent;
      z-index: 11;
    }

    .resize-handle:hover, .resize-handle.active {
      background-color: #1a73e8;
    }

    tr:hover {
      background-color: #f5f5f5;
    }

    .actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: nowrap;
    }

    button {
      padding: 0.5rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
      font-weight: 500;
      font-size: 0.875rem;
    }

    .edit-btn {
      background-color: #1a73e8;
      color: #ffffff;
    }

    .edit-btn:hover {
      background-color: #1557b0;
    }

    .delete-btn {
      background-color: #d93025;
      color: #ffffff;
    }

    .delete-btn:hover {
      background-color: #b71c1c;
    }

    .save-btn {
      background-color: #34a853;
      color: #ffffff;
    }

    .save-btn:hover {
      background-color: #2e7d32;
    }

    .cancel-btn {
      background-color: #5f6368;
      color: #ffffff;
    }

    .cancel-btn:hover {
      background-color: #4b4d51;
    }

    button.loading {
      opacity: 0.7;
      cursor: not-allowed;
      position: relative;
    }

    button.loading::after {
      content: '';
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
    }

    .edit-input, .flatpickr-input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 0.875rem;
      transition: border-color 0.2s;
    }

    .edit-input:focus, .flatpickr-input:focus {
      border-color: #1a73e8;
      outline: none;
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
    }

    .filters {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      padding: 0.5rem;
    }

    .filters select, .filters input {
      padding: 0.5rem;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 0.875rem;
      transition: border-color 0.2s;
    }

    .filters select:focus, .filters input:focus {
      border-color: #1a73e8;
      outline: none;
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
    }

    .filters button {
      background-color: #1a73e8;
      color: #ffffff;
    }

    .filters button:hover {
      background-color: #1557b0;
    }

    .pagination {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .pagination button {
      padding: 0.5rem 1rem;
      background-color: #e8eaed;
      color: #202124;
      border-radius: 4px;
      border: 1px solid #dadce0;
    }

    .pagination button:disabled {
      background-color: #f1f3f4;
      color: #5f6368;
      cursor: not-allowed;
    }

    .pagination button[data-active="true"] {
      background-color: #d2e3fc;
      color: #1a73e8;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background-color: #ffffff;
      padding: 1.5rem;
      border-radius: 4px;
      width: 90%;
      max-width: 400px;
      border: 1px solid #dadce0;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .modal-content h2 {
      margin-bottom: 1rem;
      font-weight: 500;
      color: #202124;
      font-size: 1.25rem;
    }

    .modal-content input {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 0.875rem;
      transition: border-color 0.2s;
    }

    .modal-content input:focus {
      border-color: #1a73e8;
      outline: none;
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
    }

    .modal-content button {
      width: 100%;
      padding: 0.5rem;
      background-color: #1a73e8;
      color: #ffffff;
      border-radius: 4px;
      margin-bottom: 0.5rem;
    }

    .modal-content button:hover {
      background-color: #1557b0;
    }

    .error-message {
      color: #d93025;
      margin-top: 0.5rem;
      text-align: center;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.875rem;
    }

    .error-message.show {
      opacity: 1;
    }

    .error-message.hidden {
      opacity: 0;
      display: none;
    }

    .chart-container {
      margin-top: 1.5rem;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      background-color: #ffffff;
      padding: 1rem;
      border-radius: 4px;
      border: 1px solid #dadce0;
    }

    [data-tooltip] {
      position: relative;
    }

    [data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background-color: #5f6368;
      color: #ffffff;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      white-space: nowrap;
      z-index: 10;
      font-size: 0.75rem;
    }

    .sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
    }

    .sort-indicator {
      font-size: 0.8em;
      margin-left: 4px;
      color: #888;
      position: relative;
      top: -1px;
    }

    .present-status {
      color: #34a853;
      font-weight: bold;
    }
    .absent-status {
      color: #d93025;
      font-weight: bold;
    }

    @media (max-width: 768px) {
      header h1 {
        font-size: 1.125rem;
      }

      header img {
        max-width: 120px;
      }

      #logoutButton {
        padding: 0.4rem 0.8rem;
        font-size: 0.75rem;
      }

      .tabs {
        flex-direction: column;
        gap: 0.25rem;
      }

      .tab {
        padding: 0.4rem 0.8rem;
        font-size: 0.875rem;
      }

      .filters {
        flex-direction: column;
      }

      .filters select, .filters input, .filters button {
        width: 100%;
        font-size: 0.875rem;
      }

      th, td {
        padding: 0.5rem;
        font-size: 0.75rem;
        min-width: 80px;
      }

      .table-container {
        overflow-x: auto;
      }
    }
  </style>
</head>
<body>
  <div id="pageLoader">
    <div class="loader-spinner"></div>
  </div>

  <header>
    <img src="images/logo.svg" alt="ISET QA Logo">
    <h1>ISET QA Handbook and Attendance Tracker</h1>
    <button id="logoutButton" onclick="handleLogout()">Logout</button>
  </header>

  <div id="loginModal" class="modal show">
    <div class="modal-content">
      <h2>Login</h2>
      <input type="email" id="email" placeholder="Email" value="admin@example.com">
      <input type="password" id="password" placeholder="Password" value="password123">
      <button onclick="handleLogin()">Login</button>
      <div id="loginErrorMessage" class="error-message hidden"></div>
    </div>
  </div>

  <div id="addCourseModal" class="modal">
    <div class="modal-content">
      <h2>Add New Course</h2>
      <input type="text" id="newCourseName" placeholder="Enter course name">
      <button onclick="addNewCourse()">Add Course</button>
      <button onclick="closeAddCourseModal()">Cancel</button>
      <div id="addCourseErrorMessage" class="error-message hidden"></div>
    </div>
  </div>

  <div id="mainContent" style="display: none;">
    <nav>
      <div class="tabs">
        <div class="tab active" data-tab="weeklyTab">Weekly Plan</div>
        <div class="tab" data-tab="attendanceTab">Attendance</div>
        <div class="tab" data-tab="modulesTab">Modules</div>
      </div>
    </nav>

    <div id="weeklyTab" class="tab-content" style="display: block;">
      <div class="filters">
        <select id="weekFilter" onchange="filterTable('weekly')">
          <option value="">Filter by Week</option>
        </select>
        <select id="courseFilterWeekly" onchange="filterTable('weekly')">
          <option value="">Filter by Course</option>
        </select>
        <input type="text" id="moduleFilter" placeholder="Filter by Module" oninput="filterTable('weekly')">
        <input type="text" id="dateFilter" placeholder="Filter by Date">
        <button onclick="resetFilters('weekly')">Reset Filters</button>
        <button onclick="addNewRow('weekly')">Add New Row</button>
        <button onclick="exportTableToExcel('weeklyTable')">Export to Excel</button>
      </div>
      <div class="table-container">
        <table id="weeklyTable">
          <thead>
            <tr>
              <th class="sortable" data-column="week">Week<span class="sort-indicator"></span><div class="resize-handle"></div></th>
              <th class="sortable" data-column="number">Number<span class="sort-indicator"></span><div class="resize-handle"></div></th>
              <th class="sortable" data-column="course_name">Course<span class="sort-indicator"></span><div class="resize-handle"></div></th>
              <th class="sortable" data-column="modules">Modules<span class="sort-indicator"></span><div class="resize-handle"></div></th>
              <th class="sortable" data-column="topics">Topics<span class="sort-indicator"></span><div class="resize-handle"></div></th>
              <th class="sortable" data-column="date">Date<span class="sort-indicator"></span><div class="resize-handle"></div></th>
              <th class="sortable" data-column="duration">Duration<span class="sort-indicator"></span><div class="resize-handle"></div></th>
              <th class="sortable" data-column="class_number">Class Number<span class="sort-indicator"></span><div class="resize-handle"></div></th>
              <th class="sortable" data-column="note_links">Note Links<span class="sort-indicator"></span><div class="resize-handle"></div></th>
              <th class="sortable" data-column="task_list">Task List<span class="sort-indicator"></span><div class="resize-handle"></div></th>
              <th class="sortable" data-column="task_links">Task Links<span class="sort-indicator"></span><div class="resize-handle"></div></th>
              <th class="sortable" data-column="additional_tasks">Additional Tasks<span class="sort-indicator"></span><div class="resize-handle"></div></th>
              <th class="sortable" data-column="instructor">Instructor<span class="sort-indicator"></span><div class="resize-handle"></div></th>
              <th class="sortable" data-column="status">Status<span class="sort-indicator"></span><div class="resize-handle"></div></th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="weeklyPagination" class="pagination"></div>
      <div id="errorMessage" class="error-message hidden"></div>
    </div>

    <div id="attendanceTab" class="tab-content">
      <div class="filters">
        <input type="text" id="attendanceDateFilter" placeholder="Filter by Date">
        <select id="statusFilter" onchange="filterTable('attendance')">
          <option value="">Filter by Status</option>
          <option value="Present">Present</option>
          <option value="Absent">Absent</option>
        </select>
        <button onclick="resetFilters('attendance')">Reset Filters</button>
        <button onclick="addNewRow('attendance')">Add New Row</button>
        <button onclick="exportTableToExcel('attendanceTable')">Export to Excel</button>
      </div>
      <div class="table-container">
        <table id="attendanceTable">
          <thead>
            <tr>
              <th class="sortable" data-column="student_name">Student Name<span class="sort-indicator"></span><div class="resize-handle"></div></th>
              <th class="sortable" data-column="date">Date<span class="sort-indicator"></span><div class="resize-handle"></div></th>
              <th class="sortable" data-column="status">Status<span class="sort-indicator"></span><div class="resize-handle"></div></th>
              <th class="sortable" data-column="notes">Notes<span class="sort-indicator"></span><div class="resize-handle"></div></th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="attendancePagination" class="pagination"></div>
      <div class="chart-container">
        <canvas id="attendanceChart"></canvas>
      </div>
    </div>

    <div id="modulesTab" class="tab-content">
      <div class="filters">
        <select id="courseFilter" onchange="filterTable('modules')">
          <option value="">Filter by Course</option>
        </select>
        <input type="text" id="moduleNameFilter" placeholder="Filter by Module Name" oninput="filterTable('modules')">
        <button onclick="resetFilters('modules')">Reset Filters</button>
        <button onclick="addNewRow('modules')">Add New Row</button>
        <button onclick="showAddCourseModal()">Add Course</button>
        <button onclick="exportTableToExcel('moduleTable')">Export to Excel</button>
      </div>
      <div class="table-container">
        <table id="moduleTable">
          <thead>
            <tr>
              <th class="sortable" data-column="course_name">Course<span class="sort-indicator"></span><div class="resize-handle"></div></th>
              <th class="sortable" data-column="module_name">Module Name<span class="sort-indicator"></span><div class="resize-handle"></div></th>
              <th class="sortable" data-column="description">Description<span class="sort-indicator"></span><div class="resize-handle"></div></th>
              <th class="sortable" data-column="duration">Duration (hrs)<span class="sort-indicator"></span><div class="resize-handle"></div></th>
              <th class="sortable" data-column="topics">Topics<span class="sort-indicator"></span><div class="resize-handle"></div></th>
              <th class="sortable" data-column="timestamp">Last Modified (IST)<span class="sort-indicator"></span><div class="resize-handle"></div></th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="modulePagination" class="pagination"></div>
    </div>
  </div>

  <script>
    if (typeof supabase === 'undefined') {
      console.error('Supabase library failed to load. Please check the CDN URL.');
      document.addEventListener('DOMContentLoaded', () => {
        const errorMessage = document.getElementById('loginErrorMessage');
        if (errorMessage) {
          errorMessage.textContent = 'Application error: Supabase library failed to load.';
          errorMessage.classList.remove('hidden');
          errorMessage.classList.add('show');
        }
        hidePageLoader();
      });
    }

    const SUPABASE_URL = 'https://rrdjygjylthrzygzkrnr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyZGp5Z2p5bHRocnp5Z3prcm5yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1MTYyMjAsImV4cCI6MjA2NDA5MjIyMH0.i7A1LO7SL_Qqr7Z2Oq8ObpafYflrY4mPCXx2UnX2bHs'; // <-- Replace with your new anon/public key
    let supabaseClient;
    try {
      supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } catch (err) {
      console.error('Failed to initialize Supabase client:', err);
      document.addEventListener('DOMContentLoaded', () => {
        const errorMessage = document.getElementById('loginErrorMessage');
        if (errorMessage) {
          errorMessage.textContent = 'Application error: Failed to initialize Supabase client.';
          errorMessage.classList.remove('hidden');
          errorMessage.classList.add('show');
        }
        hidePageLoader();
      });
    }

    let weeklyRows = [];
    let attendanceRows = [];
    let moduleRows = [];
    let courses = [];
    const rowsPerPage = 15;
    let currentPages = { weekly: 1, attendance: 1, modules: 1 };
    let filteredRows = { weekly: [], attendance: [], modules: [] };
    let datepickers = [];
    let attendanceChart;

    const studentNames = [
      'Toms Babu',
      'Muhamad Shaheen',
      'Jijin S',
      'Muhammad Sanshad',
      'Sooraj P',
      'Afsal Rahiman',
      'Muhammad Ishak',
      'Safvan'
    ];

    const sortState = {
      weekly: { column: null, direction: 'asc' },
      attendance: { column: null, direction: 'asc' },
      modules: { column: null, direction: 'asc' }
    };

    const sampleWeeklyData = [
      {
        id: generateUUID(),
        week: "Week 1",
        number: "1",
        course_id: null,
        modules: "Introduction to QA",
        topics: "QA Fundamentals, Testing Principles",
        date: "2025-06-01",
        duration: "2 hours",
        class_number: "C101",
        note_links: "https://docs.google.com/doc1",
        task_list: "Task 1, Task 2",
        task_links: "https://docs.google.com/task1",
        additional_tasks: "Backup Task 1",
        instructor: "Jane Smith",
        status: "Planned",
        timestamp: new Date().toISOString()
      }
    ];
    const sampleAttendanceData = [
      {
        id: generateUUID(),
        student_name: "Toms Babu",
        date: "2025-06-01",
        status: "Present",
        notes: "Attended full session",
        course_id: null,
        session_type: "Lecture",
        duration_minutes: 120,
        timestamp: new Date().toISOString()
      }
    ];
    const sampleModuleData = [
      {
        id: generateUUID(),
        course_id: null,
        module_name: "Automation Testing",
        description: "Introduction to Selenium and automation frameworks",
        duration: 4,
        topics: "Selenium WebDriver, TestNG",
        prerequisites: "Basic understanding of manual testing",
        learning_objectives: "Learn automation testing basics",
        timestamp: new Date().toISOString()
      }
    ];
    const sampleCourses = [
      { id: generateUUID(), name: "Advanced Software Testing", description: "Covers advanced testing techniques" },
      { id: generateUUID(), name: "Basic Testing Course", description: "Introduction to software testing" },
      { id: generateUUID(), name: "Add-on Testing Course", description: "Additional testing modules" },
      { id: generateUUID(), name: "40 Days Testing Course", description: "Intensive 40-day testing program" }
    ];

    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function showError(message, elementId = 'errorMessage') {
      const errorMessage = document.getElementById(elementId);
      if (errorMessage) {
        errorMessage.textContent = message;
        errorMessage.classList.remove('hidden');
        errorMessage.classList.add('show');
        setTimeout(() => {
          errorMessage.classList.remove('show');
          errorMessage.classList.add('hidden');
        }, 5000);
      }
    }

    function isValidUrl(string) {
      try {
        new URL(string);
        return true;
      } catch (_) {
        return false;
      }
    }

    function hidePageLoader() {
      const loader = document.getElementById('pageLoader');
      if (loader) {
        loader.classList.add('hidden');
      }
    }

    function showPageLoader() {
      const loader = document.getElementById('pageLoader');
      if (loader) {
        loader.classList.remove('hidden');
      }
    }

    function formatTimestampToIST(utcTimestamp) {
      const date = new Date(utcTimestamp);
      return date.toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });
    }

    async function checkAuthState() {
      if (!supabaseClient) {
        showError('Supabase client not initialized.', 'loginErrorMessage');
        hidePageLoader();
        return;
      }
      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
          document.getElementById('loginModal').style.display = 'none';
          document.getElementById('mainContent').style.display = 'block';
          document.getElementById('logoutButton').style.display = 'inline-flex';
          await loadDataFromSupabase();
        } else {
          document.getElementById('loginModal').style.display = 'flex';
          document.getElementById('mainContent').style.display = 'none';
          document.getElementById('logoutButton').style.display = 'none';
          hidePageLoader();
        }
      } catch (err) {
        showError('Failed to check authentication state: ' + err.message, 'loginErrorMessage');
        hidePageLoader();
      }
    }

    async function handleLogin() {
      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');
      const loginButton = document.querySelector('#loginModal button');
      if (!emailInput || !passwordInput || !loginButton) {
        showError('Login form elements are missing.', 'loginErrorMessage');
        hidePageLoader();
        return;
      }
      const email = emailInput.value;
      const password = passwordInput.value;

      if (!email || !password) {
        showError('Please enter email and password.', 'loginErrorMessage');
        hidePageLoader();
        return;
      }

      if (!supabaseClient) {
        showError('Supabase client not initialized.', 'loginErrorMessage');
        hidePageLoader();
        return;
      }

      loginButton.classList.add('loading');
      loginButton.disabled = true;
      showPageLoader();

      try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email,
          password
        });

        if (error) {
          showError('Login failed: ' + error.message, 'loginErrorMessage');
          hidePageLoader();
          return;
        }

        if (!data.session) {
          showError('Login failed: No session returned.', 'loginErrorMessage');
          hidePageLoader();
          return;
        }

        document.getElementById('loginModal').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        document.getElementById('logoutButton').style.display = 'inline-flex';
        await loadDataFromSupabase();
      } catch (err) {
        showError('Login failed: ' + err.message, 'loginErrorMessage');
        hidePageLoader();
      } finally {
        loginButton.classList.remove('loading');
        loginButton.disabled = false;
      }
    }

    async function handleLogout() {
      const logoutButton = document.getElementById('logoutButton');
      if (!logoutButton) return;

      logoutButton.classList.add('loading');
      logoutButton.disabled = true;
      showPageLoader();

      try {
        const { error } = await supabaseClient.auth.signOut();
        if (error) throw error;

        document.getElementById('loginModal').style.display = 'flex';
        document.getElementById('mainContent').style.display = 'none';
        document.getElementById('logoutButton').style.display = 'none';
        document.getElementById('email').value = '';
        document.getElementById('password').value = '';
        weeklyRows = [];
        attendanceRows = [];
        moduleRows = [];
        courses = [];
        filteredRows = { weekly: [], attendance: [], modules: [] };
        if (attendanceChart) {
          attendanceChart.destroy();
          attendanceChart = null;
        }
        hidePageLoader();
      } catch (err) {
        showError('Logout failed: ' + err.message);
        hidePageLoader();
      } finally {
        logoutButton.classList.remove('loading');
        logoutButton.disabled = false;
      }
    }

    function showAddCourseModal() {
      document.getElementById('addCourseModal').classList.add('show');
      document.getElementById('newCourseName').value = '';
      document.getElementById('addCourseErrorMessage').classList.add('hidden');
    }

    function closeAddCourseModal() {
      document.getElementById('addCourseModal').classList.remove('show');
    }

    async function addNewCourse() {
      const courseNameInput = document.getElementById('newCourseName');
      const courseName = courseNameInput.value.trim();
      if (!courseName) {
        showError('Course name is required.', 'addCourseErrorMessage');
        return;
      }

      if (courses.some(course => course.name.toLowerCase() === courseName.toLowerCase())) {
        showError('Course already exists.', 'addCourseErrorMessage');
        return;
      }

      const newCourse = {
        id: generateUUID(),
        name: courseName
      };

      try {
        const { error } = await supabaseClient.from('courses').insert([newCourse]);
        if (error) throw error;
        courses.push(newCourse);
        updateCourseFilters();
        closeAddCourseModal();
        alert('Course added successfully!');
      } catch (err) {
        showError('Failed to add course: ' + err.message, 'addCourseErrorMessage');
      }
    }

    function updateCourseFilters() {
      const courseFilterWeekly = document.getElementById('courseFilterWeekly');
      const courseFilterModules = document.getElementById('courseFilter');
      if (courseFilterWeekly && courseFilterModules) {
        const options = ['<option value="">Filter by Course</option>'];
        courses.sort((a, b) => a.name.localeCompare(b.name)).forEach(course => {
          options.push(`<option value="${course.id}">${course.name}</option>`);
        });
        courseFilterWeekly.innerHTML = options.join('');
        courseFilterModules.innerHTML = options.join('');
      }
    }

    function resetAllFilters() {
      const tabs = ['weekly', 'attendance', 'modules'];
      tabs.forEach(tab => {
        if (tab === 'weekly') {
          const weekFilter = document.getElementById('weekFilter');
          const courseFilterWeekly = document.getElementById('courseFilterWeekly');
          const moduleFilter = document.getElementById('moduleFilter');
          const dateFilter = document.getElementById('dateFilter');
          if (weekFilter) weekFilter.value = '';
          if (courseFilterWeekly) courseFilterWeekly.value = '';
          if (moduleFilter) moduleFilter.value = '';
          if (dateFilter) dateFilter.value = '';
        } else if (tab === 'attendance') {
          const attendanceDateFilter = document.getElementById('attendanceDateFilter');
          const statusFilter = document.getElementById('statusFilter');
          if (attendanceDateFilter) attendanceDateFilter.value = '';
          if (statusFilter) statusFilter.value = '';
        } else {
          const courseFilter = document.getElementById('courseFilter');
          const moduleNameFilter = document.getElementById('moduleNameFilter');
          if (courseFilter) courseFilter.value = '';
          if (moduleNameFilter) moduleNameFilter.value = '';
        }
        currentPages[tab] = 1;
        filteredRows[tab] = [...(tab === 'weekly' ? weeklyRows : tab === 'attendance' ? attendanceRows : moduleRows)];
      });
    }

    function initializeTables() {
      const tables = [
        { tableId: 'weeklyTable', rows: filteredRows.weekly, tab: 'weekly', paginationId: 'weeklyPagination' },
        { tableId: 'attendanceTable', rows: filteredRows.attendance, tab: 'attendance', paginationId: 'attendancePagination' },
        { tableId: 'moduleTable', rows: filteredRows.modules, tab: 'modules', paginationId: 'modulePagination' }
      ];

      tables.forEach(({ tableId, rows, tab, paginationId }) => {
        const tableBody = document.querySelector(`#${tableId} tbody`);
        if (!tableBody) {
          console.error(`Table body for ${tableId} not found`);
          return;
        }
        renderTableRows(tableId, rows, tab);
        updatePagination(paginationId, rows.length, tab);
        initializeColumnResizing(tableId);
      });

      updateWeekFilter(weeklyRows);
      updateCourseFilters();
      updateAttendanceChart();
      hidePageLoader();
    }

    function initializeColumnResizing(tableId) {
      const table = document.getElementById(tableId);
      if (!table) return;
      const headers = table.querySelectorAll('th');
      let resizingElement = null;
      let startX, startWidth;

      headers.forEach((header, index) => {
        const resizeHandle = header.querySelector('.resize-handle');
        if (!resizeHandle) return;

        resizeHandle.addEventListener('mousedown', (e) => {
          resizingElement = header;
          startX = e.clientX;
          startWidth = header.offsetWidth;
          resizeHandle.classList.add('active');
          document.addEventListener('mousemove', handleMouseMove);
          document.addEventListener('mouseup', handleMouseUp);
        });
      });

      function handleMouseMove(e) {
        if (resizingElement) {
          const newWidth = startWidth + (e.clientX - startX);
          const minWidth = 50;
          resizingElement.style.width = `${Math.max(minWidth, newWidth)}px`;
        }
      }

      function handleMouseUp() {
        if (resizingElement) {
          resizingElement.querySelector('.resize-handle').classList.remove('active');
          resizingElement = null;
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
        }
      }
    }

    async function loadDataFromSupabase() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        handleLogout();
        return;
      }

      currentPages = { weekly: 1, attendance: 1, modules: 1 };
      resetAllFilters();

      try {
        let { data, error } = await supabaseClient.from('courses').select('*');
        if (error) throw error;

        if (!data || data.length === 0) {
          await supabaseClient.from('courses').insert(sampleCourses);
          data = sampleCourses;
        }

        courses.length = 0;
        courses.push(...data);
      } catch (err) {
        console.error('Error loading courses data:', err);
        showError('Failed to load courses data: ' + err.message);
        courses.length = 0;
        courses.push(...sampleCourses);
      }

      const collections = [
        { 
          name: 'weekly_plan', 
          rows: weeklyRows, 
          sampleData: sampleWeeklyData.map(row => ({
            ...row,
            course_id: courses.find(c => c.name === 'Advanced Software Testing')?.id || courses[0]?.id
          })), 
          table: 'weekly_plan',
          query: () => supabaseClient
            .from('weekly_plan')
            .select('*, courses!weekly_plan_course_fkey(name)')
        },
        { 
          name: 'attendance', 
          rows: attendanceRows, 
          sampleData: sampleAttendanceData.map(row => ({
            ...row,
            course_id: courses.find(c => c.name === 'Basic Testing Course')?.id || courses[0]?.id
          })), 
          table: 'attendance',
          query: () => supabaseClient.from('attendance').select('*')
        },
        { 
          name: 'modules', 
          rows: moduleRows, 
          sampleData: sampleModuleData.map(row => ({
            ...row,
            course_id: courses.find(c => c.name === 'Advanced Software Testing')?.id || courses[0]?.id
          })), 
          table: 'modules',
          query: () => supabaseClient
            .from('modules')
            .select('*, courses!modules_course_fkey(name)')
        }
      ];

      for (const collection of collections) {
        try {
          let { data, error } = await collection.query();
          if (error) throw error;

          if (!data || data.length === 0) {
            const { data: existingData, error: fetchError } = await supabaseClient.from(collection.table).select('id');
            if (fetchError) throw fetchError;
            if (!existingData.some(row => collection.sampleData.some(sample => sample.id === row.id))) {
              await supabaseClient.from(collection.table).insert(collection.sampleData);
              const { data: newData, error: newError } = await collection.query();
              if (newError) throw newError;
              data = newData || collection.sampleData;
            } else {
              data = existingData;
            }
          }

          collection.rows.length = 0;
          collection.rows.push(...data.map(row => ({
            ...row,
            rowId: row.id,
            course_name: row.courses?.name || courses.find(c => c.id === row.course_id)?.name || 'Unknown Course'
          })));
          filteredRows[collection.name.replace('_plan', '')] = [...collection.rows];
        } catch (err) {
          console.error(`Error loading ${collection.name} data:`, err);
          showError(`Failed to load ${collection.name} data: ${err.message}`);
          collection.rows.length = 0;
          collection.rows.push(...collection.sampleData.map(row => ({
            ...row,
            rowId: row.id,
            course_name: courses.find(c => c.id === row.course_id)?.name || 'Unknown Course'
          })));
          filteredRows[collection.name.replace('_plan', '')] = [...collection.rows];
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        initializeTables();
      });
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        initializeTables();
      }
    }

    async function saveDataToSupabase(tab, rowData) {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        handleLogout();
        return false;
      }

      const tableName = tab === 'weekly' ? 'weekly_plan' :
                        tab === 'attendance' ? 'attendance' :
                        'modules';
      try {
        const { error } = await supabaseClient.from(tableName).upsert([rowData]);
        if (error) throw error;
        return true;
      } catch (err) {
        console.error(`Error saving ${tab} data:`, err);
        showError(`Failed to save ${tab} data: ${err.message}`);
        return false;
      }
    }

    async function deleteDataFromSupabase(tab, rowId) {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        handleLogout();
        return false;
      }

      const tableName = tab === 'weekly' ? 'weekly_plan' :
                        tab === 'attendance' ? 'attendance' :
                        'modules';
      try {
        const { error } = await supabaseClient.from(tableName).delete().eq('id', rowId);
        if (error) throw error;
        return true;
      } catch (err) {
        console.error(`Error deleting ${tab} data:`, err);
        showError(`Failed to delete ${tab} data: ${err.message}`);
        return false;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const dateFilter = document.getElementById('dateFilter');
      const attendanceDateFilter = document.getElementById('attendanceDateFilter');
      if (dateFilter) {
        flatpickr(dateFilter, {
          dateFormat: 'Y-m-d',
          allowInput: false,
          onChange: () => filterTable('weekly')
        });
      }
      if (attendanceDateFilter) {
        flatpickr(attendanceDateFilter, {
          dateFormat: 'Y-m-d',
          allowInput: false,
          onChange: () => filterTable('attendance')
        });
      }
    });

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', async () => {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) {
          handleLogout();
          return;
        }

        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
        document.getElementById(tab.getAttribute('data-tab')).style.display = 'block';

        const tabName = tab.getAttribute('data-tab') === 'weeklyTab' ? 'weekly' :
                        tab.getAttribute('data-tab') === 'attendanceTab' ? 'attendance' :
                        'modules';
        const tableId = tabName + 'Table';
        const rows = filteredRows[tabName];
        currentPages[tabName] = 1;
        renderTableRows(tableId, rows, tabName);
        updatePagination(tabName + 'Pagination', rows.length, tabName);
        initializeColumnResizing(tableId);

        if (tabName === 'attendance') {
          updateAttendanceChart();
        }
      });
    });

    function updateWeekFilter(rows) {
      const weekFilter = document.getElementById('weekFilter');
      if (!weekFilter) return;
      
      weekFilter.innerHTML = '<option value="">Filter by Week</option>';
      
      const weeks = [...new Set(rows
        .map(row => row.week || '')
        .filter(week => week.trim()))]
        .sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
      
      weeks.forEach(week => {
        const option = document.createElement('option');
        option.value = week;
        option.textContent = week;
        weekFilter.appendChild(option);
      });
    }

    function updateAttendanceChart() {
      const ctx = document.getElementById('attendanceChart')?.getContext('2d');
      if (!ctx) return;

      // Student-wise present/absent count
      const studentMap = {};
      filteredRows.attendance.forEach(row => {
        const name = row.student_name || 'Unknown';
        if (!studentMap[name]) studentMap[name] = { Present: 0, Absent: 0 };
        if ((row.status || '').toLowerCase() === 'present') studentMap[name].Present++;
        else if ((row.status || '').toLowerCase() === 'absent') studentMap[name].Absent++;
      });
      const students = Object.keys(studentMap);
      const presentCounts = students.map(s => studentMap[s].Present);
      const absentCounts = students.map(s => studentMap[s].Absent);

      if (attendanceChart) {
        attendanceChart.destroy();
      }

      attendanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: students,
          datasets: [
            {
              label: 'Present',
              data: presentCounts,
              backgroundColor: '#34a853'
            },
            {
              label: 'Absent',
              data: absentCounts,
              backgroundColor: '#d93025'
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                font: {
                  family: 'Roboto',
                  size: 14
                },
                color: '#202124'
              }
            },
            title: {
              display: true,
              text: 'Attendance Overview (Student-wise)',
              font: {
                family: 'Roboto',
                size: 16,
                weight: '500'
              },
              color: '#202124'
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Student'
              }
            },
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Count'
              }
            }
          }
        }
      });
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    window.filterTable = debounce(async function(tab) {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        handleLogout();
        return;
      }

      currentPages[tab] = 1;

      const filters = {
        weekly: {
          rows: weeklyRows,
          tableId: 'weeklyTable',
          paginationId: 'weeklyPagination',
          getFilters: () => ({
            week: (document.getElementById('weekFilter')?.value || '').toLowerCase(),
            course_id: document.getElementById('courseFilterWeekly')?.value || '',
            module: (document.getElementById('moduleFilter')?.value || '').toLowerCase(),
            date: document.getElementById('dateFilter')?.value || ''
          }),
          filterFn: (row, filters) => {
            const week = (row.week || '').toLowerCase();
            const matchesWeek = !filters.week || week.includes(filters.week);
            const matchesCourse = !filters.course_id || (row.course_id && row.course_id === filters.course_id);
            const moduleVal = (row.modules || '').toLowerCase();
            const matchesModule = !filters.module || moduleVal.includes(filters.module);
            let matchesDate = true;
            if (filters.date) {
              const rowDate = row.date ? new Date(row.date) : null;
              matchesDate = rowDate && rowDate.toISOString().split('T')[0] === filters.date;
            }
            return matchesWeek && matchesCourse && matchesModule && matchesDate;
          }
        },
        attendance: {
          rows: attendanceRows,
          tableId: 'attendanceTable',
          paginationId: 'attendancePagination',
          getFilters: () => ({
            date: document.getElementById('attendanceDateFilter')?.value || '',
            status: document.getElementById('statusFilter')?.value || ''
          }),
          filterFn: (row, filters) => {
            const matchesStatus = !filters.status || (row.status && row.status === filters.status);
            let matchesDate = true;
            if (filters.date) {
              const rowDate = row.date ? new Date(row.date) : null;
              matchesDate = rowDate && rowDate.toISOString().split('T')[0] === filters.date;
            }
            return matchesDate && matchesStatus;
          }
        },
        modules: {
          rows: moduleRows,
          tableId: 'moduleTable',
          paginationId: 'modulePagination',
          getFilters: () => ({
            course_id: document.getElementById('courseFilter')?.value || '',
            module: (document.getElementById('moduleNameFilter')?.value || '').toLowerCase()
          }),
          filterFn: (row, filters) => {
            const matchesCourse = !filters.course_id || (row.course_id && row.course_id === filters.course_id);
            const moduleName = (row.module_name || '').toLowerCase();
            const matchesModule = !filters.module || moduleName.includes(filters.module);
            return matchesCourse && matchesModule;
          }
        }
      };

      const { rows, tableId, paginationId, getFilters, filterFn } = filters[tab];
      const filterValues = getFilters();
      console.log(`[${tab}] Filter values:`, filterValues);
      filteredRows[tab] = rows.filter(row => filterFn(row, filterValues));
      console.log(`[${tab}] Filtered rows:`, filteredRows[tab]);
      renderTableRows(tableId, filteredRows[tab], tab);
      updatePagination(paginationId, filteredRows[tab].length, tab);
      initializeColumnResizing(tableId);

      if (tab === 'attendance') {
        updateAttendanceChart();
      }
    }, 200);

    function sortRows(tab, column) {
      if (!column) return;
      const state = sortState[tab];
      if (state.column === column) {
        state.direction = state.direction === 'asc' ? 'desc' : 'asc';
      } else {
        state.column = column;
        state.direction = 'asc';
      }
      filteredRows[tab].sort((a, b) => {
        let aVal = a[column] ?? '';
        let bVal = b[column] ?? '';
        if (!isNaN(parseFloat(aVal)) && !isNaN(parseFloat(bVal))) {
          aVal = parseFloat(aVal);
          bVal = parseFloat(bVal);
        } else {
          aVal = (aVal + '').toLowerCase();
          bVal = (bVal + '').toLowerCase();
        }
        if (aVal < bVal) return state.direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return state.direction === 'asc' ? 1 : -1;
        return 0;
      });
      currentPages[tab] = 1;
      renderTableRows(tab + 'Table', filteredRows[tab], tab);
      updatePagination(tab + 'Pagination', filteredRows[tab].length, tab);
      updateSortIndicators(tab);
    }

    function updateSortIndicators(tab) {
      const tableId = tab + 'Table';
      const ths = document.querySelectorAll(`#${tableId} th.sortable`);
      ths.forEach(th => {
        const indicator = th.querySelector('.sort-indicator');
        if (!indicator) return;
        const col = th.getAttribute('data-column');
        if (sortState[tab].column === col) {
          indicator.textContent = sortState[tab].direction === 'asc' ? '▲' : '▼';
          th.classList.add('sorted');
        } else {
          indicator.textContent = '';
          th.classList.remove('sorted');
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      ['weekly', 'attendance', 'modules'].forEach(tab => {
        const tableId = tab + 'Table';
        const ths = document.querySelectorAll(`#${tableId} th.sortable`);
        ths.forEach(th => {
          th.onclick = (e) => {
            if (e.target.classList.contains('resize-handle')) return;
            sortRows(tab, th.getAttribute('data-column'));
          };
        });
      });
    });

    function renderTableRows(tableId, rows, tab) {
      const tableBody = document.querySelector(`#${tableId} tbody`);
      if (!tableBody) {
        console.error(`Table body for ${tableId} not found`);
        return;
      }
      tableBody.innerHTML = '';
      const start = (currentPages[tab] - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const paginatedRows = rows.slice(start, end);

      if (paginatedRows.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="${tableId === 'weeklyTable' ? 15 : tableId === 'attendanceTable' ? 5 : 7}">No data available</td></tr>`;
        updateSortIndicators(tab);
        return;
      }

      paginatedRows.forEach(row => {
        const newRow = document.createElement('tr');
        newRow.setAttribute('data-rowid', row.rowId);
        if (tableId === 'weeklyTable') {
          newRow.innerHTML = `
            <td>${row.week || ''}</td>
            <td>${row.number || ''}</td>
            <td>${row.course_name || ''}</td>
            <td>${row.modules || ''}</td>
            <td>${row.topics || ''}</td>
            <td>${row.date || ''}</td>
            <td>${row.duration || ''}</td>
            <td>${row.class_number || ''}</td>
            <td><a href="${row.note_links || ''}" target="_blank">${row.note_links || ''}</a></td>
            <td>${row.task_list || ''}</td>
            <td><a href="${row.task_links || ''}" target="_blank">${row.task_links || ''}</a></td>
            <td>${row.additional_tasks || ''}</td>
            <td>${row.instructor || ''}</td>
            <td>${row.status || ''}</td>
            <td class="actions">
              <button class="edit-btn" onclick="editRow(event, this, '${tab}')" data-tooltip="Edit Row"><i class="fas fa-edit"></i></button>
              <button class="delete-btn" onclick="deleteRow(event, this, '${tab}')" data-tooltip="Delete Row"><i class="fas fa-trash"></i></button>
            </td>
          `;
        } else if (tableId === 'attendanceTable') {
          // Add color for Present/Absent
          let statusClass = '';
          if ((row.status || '').toLowerCase() === 'present') statusClass = 'present-status';
          else if ((row.status || '').toLowerCase() === 'absent') statusClass = 'absent-status';
          newRow.innerHTML = `
            <td>${row.student_name || ''}</td>
            <td>${row.date || ''}</td>
            <td><span class="${statusClass}">${row.status || ''}</span></td>
            <td>${row.notes || ''}</td>
            <td class="actions">
              <button class="edit-btn" onclick="editRow(event, this, '${tab}')" data-tooltip="Edit Row"><i class="fas fa-edit"></i></button>
              <button class="delete-btn" onclick="deleteRow(event, this, '${tab}')" data-tooltip="Delete Row"><i class="fas fa-trash"></i></button>
            </td>
          `;
        } else {
          newRow.innerHTML = `
            <td>${row.course_name || ''}</td>
            <td>${row.module_name || ''}</td>
            <td>${row.description || ''}</td>
            <td>${row.duration || ''}</td>
            <td>${row.topics || ''}</td>
            <td>${row.timestamp ? formatTimestampToIST(row.timestamp) : ''}</td>
            <td class="actions">
              <button class="edit-btn" onclick="editRow(event, this, '${tab}')" data-tooltip="Edit Row"><i class="fas fa-edit"></i></button>
              <button class="delete-btn" onclick="deleteRow(event, this, '${tab}')" data-tooltip="Delete Row"><i class="fas fa-trash"></i></button>
            </td>
          `;
        }
        tableBody.appendChild(newRow);
      });
      updateSortIndicators(tab);
    }

    function updatePagination(paginationId, totalRows, tab) {
      const pagination = document.getElementById(paginationId);
      if (!pagination) return;
      pagination.innerHTML = '';
      const totalPages = Math.ceil(totalRows / rowsPerPage) || 1;

      if (totalRows === 0) {
        pagination.innerHTML = '<p>No pages available</p>';
        return;
      }

      const prevButton = document.createElement('button');
      prevButton.textContent = 'Previous';
      prevButton.disabled = currentPages[tab] === 1;
      prevButton.onclick = () => {
        if (currentPages[tab] > 1) {
          currentPages[tab]--;
          renderTableRows(tab + 'Table', filteredRows[tab], tab);
          updatePagination(paginationId, filteredRows[tab].length, tab);
        }
      };
      pagination.appendChild(prevButton);

      for (let i = 1; i <= totalPages; i++) {
        const pageButton = document.createElement('button');
        pageButton.textContent = i;
        pageButton.disabled = i === currentPages[tab];
        if (i === currentPages[tab]) pageButton.setAttribute('data-active', 'true');
        pageButton.onclick = () => {
          currentPages[tab] = i;
          renderTableRows(tab + 'Table', filteredRows[tab], tab);
          updatePagination(paginationId, filteredRows[tab].length, tab);
        };
        pagination.appendChild(pageButton);
      }

      const nextButton = document.createElement('button');
      nextButton.textContent = 'Next';
      nextButton.disabled = currentPages[tab] === totalPages;
      nextButton.onclick = () => {
        if (currentPages[tab] < totalPages) {
          currentPages[tab]++;
          renderTableRows(tab + 'Table', filteredRows[tab], tab);
          updatePagination(paginationId, filteredRows[tab].length, tab);
        }
      };
      pagination.appendChild(nextButton);
    }

    async function addNewRow(tab) {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        handleLogout();
        return;
      }

      const tableBody = document.querySelector(`#${tab}Table tbody`);
      if (!tableBody) return;
      const newRow = document.createElement('tr');
      const newRowId = generateUUID();
      newRow.setAttribute('data-rowid', newRowId);
      newRow.setAttribute('data-new', 'true');

      const defaultCourseId = courses[0]?.id || '';

      // Prepare default row object and push to array
      let newObj;
      if (tab === 'weekly') {
        newObj = {
          id: newRowId,
          rowId: newRowId,
          week: '',
          number: '',
          course_id: defaultCourseId,
          modules: '',
          topics: '',
          date: '',
          duration: '',
          class_number: '',
          note_links: '',
          task_list: '',
          task_links: '',
          additional_tasks: '',
          instructor: '',
          status: '',
          timestamp: new Date().toISOString(),
          course_name: courses.find(c => c.id === defaultCourseId)?.name || ''
        };
        weeklyRows.push(newObj);
        filteredRows.weekly.push(newObj);
        newRow.innerHTML = '<td></td>'.repeat(14) + '<td class="actions"><button class="edit-btn" onclick="editRow(event, this, \'weekly\')" data-tooltip="Edit Row"><i class="fas fa-edit"></i></button><button class="delete-btn" onclick="deleteRow(event, this, \'weekly\')" data-tooltip="Delete Row"><i class="fas fa-trash"></i></button></td>';
      } else if (tab === 'attendance') {
        newObj = {
          id: newRowId,
          rowId: newRowId,
          student_name: studentNames[0],
          date: '',
          status: 'Present',
          notes: '',
          course_id: defaultCourseId,
          session_type: 'Lecture',
          duration_minutes: 120,
          timestamp: new Date().toISOString()
        };
        attendanceRows.push(newObj);
        filteredRows.attendance.push(newObj);
        newRow.innerHTML = '<td></td>'.repeat(4) + '<td class="actions"><button class="edit-btn" onclick="editRow(event, this, \'attendance\')" data-tooltip="Edit Row"><i class="fas fa-edit"></i></button><button class="delete-btn" onclick="deleteRow(event, this, \'attendance\')" data-tooltip="Delete Row"><i class="fas fa-trash"></i></button></td>';
      } else {
        newObj = {
          id: newRowId,
          rowId: newRowId,
          course_id: defaultCourseId,
          module_name: '',
          description: '',
          duration: '',
          topics: '',
          timestamp: new Date().toISOString(),
          course_name: courses.find(c => c.id === defaultCourseId)?.name || ''
        };
        moduleRows.push(newObj);
        filteredRows.modules.push(newObj);
        newRow.innerHTML = `<td></td><td></td><td></td><td></td><td></td><td></td><td class="actions"><button class="edit-btn" onclick="editRow(event, this, 'modules')" data-tooltip="Edit Row"><i class="fas fa-edit"></i></button><button class="delete-btn" onclick="deleteRow(event, this, 'modules')" data-tooltip="Delete Row"><i class="fas fa-trash"></i></button></td>`;
      }
      tableBody.appendChild(newRow);
      editRow(null, newRow.querySelector('.edit-btn'), tab);
    }

    async function editRow(event, button, tab) {
      if (event) event.stopPropagation();
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        handleLogout();
        return;
      }

      const row = button.closest('tr');
      const rowId = row.getAttribute('data-rowid');
      if (!rowId) {
        showError('Error: Row ID is missing.');
        return;
      }
      datepickers.forEach(dp => dp.destroy());
      datepickers = [];

      const rows = tab === 'weekly' ? weeklyRows :
                   tab === 'attendance' ? attendanceRows :
                   moduleRows;
      let rowData = rows.find(r => r.rowId === rowId);

      // If not found but it's a new row, use a default object
      if (!rowData && row.getAttribute('data-new') === 'true') {
        const defaultCourseId = courses[0]?.id || '';
        if (tab === 'weekly') {
          rowData = {
            id: rowId,
            rowId: rowId,
            week: '',
            number: '',
            course_id: defaultCourseId,
            modules: '',
            topics: '',
            date: '',
            duration: '',
            class_number: '',
            note_links: '',
            task_list: '',
            task_links: '',
            additional_tasks: '',
            instructor: '',
            status: '',
            timestamp: new Date().toISOString(),
            course_name: courses.find(c => c.id === defaultCourseId)?.name || ''
          };
        } else if (tab === 'attendance') {
          rowData = {
            id: rowId,
            rowId: rowId,
            student_name: studentNames[0],
            date: '',
            status: 'Present',
            notes: '',
            course_id: defaultCourseId,
            session_type: 'Lecture',
            duration_minutes: 120,
            timestamp: new Date().toISOString()
          };
        } else {
          rowData = {
            id: rowId,
            rowId: rowId,
            course_id: defaultCourseId,
            module_name: '',
            description: '',
            duration: '',
            topics: '',
            timestamp: new Date().toISOString(),
            course_name: courses.find(c => c.id === defaultCourseId)?.name || ''
          };
        }
      }

      if (!rowData) {
        showError('Error: Row data not found.');
        return;
      }

      const cells = Array.from(row.children).slice(0, row.children.length - 1);
      cells.forEach((cell, index) => {
        const currentValue = cell.innerText;
        cell.innerHTML = '';
        if ((tab === 'weekly' && index === 2) || (tab === 'modules' && index === 0)) {
          const select = document.createElement('select');
          select.className = 'edit-input';
          select.innerHTML = courses.map(course => `<option value="${course.id}">${course.name}</option>`).join('');
          select.value = rowData.course_id || courses[0]?.id || '';
          cell.appendChild(select);
        } else if ((tab === 'weekly' && index === 5) || (tab === 'attendance' && index === 1)) {
          const input = document.createElement('input');
          input.className = 'flatpickr-input';
          input.readOnly = true;
          input.value = rowData.date || '';
          cell.appendChild(input);
          const fp = flatpickr(input, {
            dateFormat: 'Y-m-d',
            allowInput: false,
            defaultDate: rowData.date || null,
            onChange: (selectedDates, dateStr) => input.value = dateStr
          });
          datepickers.push(fp);
        } else if (tab === 'attendance' && index === 0) {
          const select = document.createElement('select');
          select.className = 'edit-input';
          select.innerHTML = studentNames.map(name => `<option value="${name}">${name}</option>`).join('');
          select.value = rowData.student_name || studentNames[0];
          cell.appendChild(select);
        } else if (tab === 'attendance' && index === 2) {
          const select = document.createElement('select');
          select.className = 'edit-input';
          select.innerHTML = '<option value="Present">Present</option><option value="Absent">Absent</option>';
          select.value = rowData.status || 'Present';
          cell.appendChild(select);
        } else if (tab === 'weekly' && index === 13) {
          const select = document.createElement('select');
          select.className = 'edit-input';
          select.innerHTML = '<option value="Planned">Planned</option><option value="In Progress">In Progress</option><option value="Completed">Completed</option>';
          select.value = rowData.status || 'Planned';
          cell.appendChild(select);
        } else if (tab === 'modules' && index === 5) {
          const div = document.createElement('div');
          div.textContent = formatTimestampToIST(rowData.timestamp);
          cell.appendChild(div);
        } else {
          const input = document.createElement('input');
          input.className = 'edit-input';
          // Use rowData fields for value
          let val = '';
          if (tab === 'weekly') {
            val = [
              rowData.week, rowData.number, rowData.course_name, rowData.modules, rowData.topics,
              rowData.date, rowData.duration, rowData.class_number, rowData.note_links, rowData.task_list,
              rowData.task_links, rowData.additional_tasks, rowData.instructor, rowData.status
            ][index] || '';
          } else if (tab === 'attendance') {
            val = [
              rowData.student_name, rowData.date, rowData.status, rowData.notes
            ][index] || '';
          } else {
            val = [
              rowData.course_name, rowData.module_name, rowData.description, rowData.duration, rowData.topics, rowData.timestamp
            ][index] || '';
          }
          input.value = val;
          cell.appendChild(input);
        }
      });

      const actionsCell = row.children[row.children.length - 1];
      actionsCell.innerHTML = `
        <div class="actions">
          <button class="save-btn" onclick="saveRow(event, this, '${tab}')" data-tooltip="Save Row"><i class="fas fa-save"></i></button>
          <button class="cancel-btn" onclick="cancelEdit(event, this, '${tab}')" data-tooltip="Cancel"><i class="fas fa-times"></i></button>
        </div>
      `;
    }

    async function cancelEdit(event, button, tab) {
      if (event) event.stopPropagation();
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        handleLogout();
        return;
      }

      const row = button.closest('tr');
      if (row.getAttribute('data-new') === 'true') {
        row.remove();
      } else {
        datepickers.forEach(dp => dp.destroy());
        datepickers = [];
        await loadDataFromSupabase();
      }
      const tableId = tab + 'Table';
      renderTableRows(tableId, filteredRows[tab], tab);
      updatePagination(tab + 'Pagination', filteredRows[tab].length, tab);
      initializeColumnResizing(tableId);
    }

    async function saveRow(event, button, tab) {
      if (event) event.stopPropagation();
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        handleLogout();
        return;
      }

      button.classList.add('loading');
      button.disabled = true;

      const row = button.closest('tr');
      const rowId = row.getAttribute('data-rowid');
      const isNewRow = row.getAttribute('data-new') === 'true';
      const cells = Array.from(row.children).slice(0, row.children.length - 1);
      const inputs = cells.map(cell => {
        const input = cell.querySelector('input, select');
        return input ? input.value : '';
      });

      const rowData = tab === 'weekly' ? {
        id: rowId,
        week: inputs[0],
        number: inputs[1],
        course_id: inputs[2],
        modules: inputs[3],
        topics: inputs[4],
        date: inputs[5],
        duration: inputs[6],
        class_number: inputs[7],
        note_links: inputs[8],
        task_list: inputs[9],
        task_links: inputs[10],
        additional_tasks: inputs[11],
        instructor: inputs[12],
        status: inputs[13],
        timestamp: new Date().toISOString()
      } : tab === 'attendance' ? {
        id: rowId,
        student_name: inputs[0],
        date: inputs[1],
        status: inputs[2],
        notes: inputs[3],
        course_id: courses[0]?.id || '',
        session_type: 'Lecture',
        duration_minutes: 120,
        timestamp: new Date().toISOString()
      } : {
        id: rowId,
        course_id: inputs[0],
        module_name: inputs[1],
        description: inputs[2],
        duration: inputs[3],
        topics: inputs[4],
        timestamp: new Date().toISOString()
      };

      if (!rowData.week && !rowData.student_name && !rowData.module_name) {
        showError('Key field (Week, Student Name, or Module Name) is required.');
        button.classList.remove('loading');
        button.disabled = false;
        return;
      }
      if ((tab === 'weekly' || tab === 'modules') && !rowData.course_id) {
        showError('Course selection is required.');
        button.classList.remove('loading');
        button.disabled = false;
        return;
      }
      if (tab === 'weekly') {
        if (rowData.note_links && !isValidUrl(rowData.note_links)) {
          showError('Invalid URL in Note Links.');
          button.classList.remove('loading');
          button.disabled = false;
          return;
        }
        if (rowData.task_links && !isValidUrl(rowData.task_links)) {
          showError('Invalid URL in Task Links.');
          button.classList.remove('loading');
          button.disabled = false;
          return;
        }
        if (rowData.duration && isNaN(parseFloat(rowData.duration))) {
          showError('Duration must be a valid number.');
          button.classList.remove('loading');
          button.disabled = false;
          return;
        }
      }
      if (tab === 'modules' && rowData.duration && isNaN(parseFloat(rowData.duration))) {
        showError('Duration must be a valid number.');
        button.classList.remove('loading');
        button.disabled = false;
        return;
      }

      const rows = tab === 'weekly' ? weeklyRows :
                   tab === 'attendance' ? attendanceRows :
                   moduleRows;

      const success = await saveDataToSupabase(tab, rowData);
      if (!success) {
        button.classList.remove('loading');
        button.disabled = false;
        return;
      }

      if (isNewRow) {
        rows.push({ 
          ...rowData, 
          rowId: rowId,
          course_name: courses.find(c => c.id === rowData.course_id)?.name || ''
        });
        filteredRows[tab].push({ 
          ...rowData, 
          rowId: rowId,
          course_name: courses.find(c => c.id === rowData.course_id)?.name || ''
        });
        row.removeAttribute('data-new');
      } else {
        const rowIndex = rows.findIndex(r => r.rowId === rowId);
        if (rowIndex === -1) {
          showError(`Row with ID ${rowId} not found`);
          button.classList.remove('loading');
          button.disabled = false;
          return;
        }
        rows[rowIndex] = { 
          ...rowData, 
          rowId: rowId,
          course_name: courses.find(c => c.id === rowData.course_id)?.name || ''
        };
        const filteredIndex = filteredRows[tab].findIndex(r => r.rowId === rowId);
        if (filteredIndex !== -1) {
          filteredRows[tab][filteredIndex] = { 
            ...rowData, 
            rowId: rowId,
            course_name: courses.find(c => c.id === rowData.course_id)?.name || ''
          };
        }
      }

      alert('Row saved successfully!');
      datepickers.forEach(dp => dp.destroy());
      datepickers = [];
      button.classList.remove('loading');
      button.disabled = false;
      if (tab === 'weekly') updateWeekFilter(weeklyRows);
      const tableId = tab + 'Table';
      renderTableRows(tableId, filteredRows[tab], tab);
      updatePagination(tab + 'Pagination', filteredRows[tab].length, tab);
      initializeColumnResizing(tableId);
    }

    async function deleteRow(event, button, tab) {
      if (event) event.stopPropagation();
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        handleLogout();
        return;
      }

      if (!confirm('Are you sure you want to delete this row?')) return;

      button.classList.add('loading');
      button.disabled = true;
      const row = button.closest('tr');
      const rowId = row.getAttribute('data-rowid');
      const success = await deleteDataFromSupabase(tab, rowId);
      if (!success) {
        button.classList.remove('loading');
        button.disabled = false;
        return;
      }

      const rows = tab === 'weekly' ? weeklyRows :
                   tab === 'attendance' ? attendanceRows :
                   moduleRows;
      const rowIndex = rows.findIndex(r => r.rowId === rowId);
      if (rowIndex !== -1) {
        rows.splice(rowIndex, 1);
      }
      const filteredIndex = filteredRows[tab].findIndex(r => r.rowId === rowId);
      if (filteredIndex !== -1) {
        filteredRows[tab].splice(filteredIndex, 1);
      }

      alert('Row deleted successfully!');
      button.classList.remove('loading');
      button.disabled = false;
      if (tab === 'weekly') updateWeekFilter(weeklyRows);
      const tableId = tab + 'Table';
      renderTableRows(tableId, filteredRows[tab], tab);
      updatePagination(tab + 'Pagination', filteredRows[tab].length, tab);
      initializeColumnResizing(tableId);

      if (tab === 'attendance') {
        updateAttendanceChart();
      }
    }

    function resetFilters(tab) {
      if (tab === 'weekly') {
        document.getElementById('weekFilter').value = '';
        document.getElementById('courseFilterWeekly').value = '';
        document.getElementById('moduleFilter').value = '';
        document.getElementById('dateFilter').value = '';
      } else if (tab === 'attendance') {
        document.getElementById('attendanceDateFilter').value = '';
        document.getElementById('statusFilter').value = '';
      } else {
        document.getElementById('courseFilter').value = '';
        document.getElementById('moduleNameFilter').value = '';
      }
      currentPages[tab] = 1;
      filteredRows[tab] = [...(tab === 'weekly' ? weeklyRows : tab === 'attendance' ? attendanceRows : moduleRows)];
      const tableId = tab + 'Table';
      renderTableRows(tableId, filteredRows[tab], tab);
      updatePagination(tab + 'Pagination', filteredRows[tab].length, tab);
      if (tab === 'attendance') {
        updateAttendanceChart();
      }
    }

    function exportTableToExcel(tableId) {
      const table = document.getElementById(tableId);
      if (!table) {
        showError('Table not found for export.');
        return;
      }

      const rows = Array.from(table.querySelectorAll('tr'));
      if (rows.length === 0) {
        showError('No data to export.');
        return;
      }

      const data = rows.map(row => {
        const cells = Array.from(row.querySelectorAll('th, td'));
        return cells.map(cell => {
          if (cell.classList.contains('actions')) return '';
          const input = cell.querySelector('input, select');
          return input ? input.value : cell.innerText;
        }).filter(text => text !== '');
      });

      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
      XLSX.writeFile(wb, `${tableId.replace('Table', '')}_export.xlsx`);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await checkAuthState();
      } catch (err) {
        console.error('Error during initialization:', err);
        showError('Initialization failed: ' + err.message, 'loginErrorMessage');
        hidePageLoader();
      }

      const logoutButton = document.getElementById('logoutButton');
      if (logoutButton) {
        logoutButton.addEventListener('click', handleLogout);
      }
    });
  </script>
</body>
</html>
